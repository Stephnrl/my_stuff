# group_vars/azure_rhel9_stig.yml or host_vars/yourhost.yml

# ============================================
# CORE DEVIATIONS FOR AZURE ENVIRONMENT
# ============================================

## SELinux - Set to Permissive (your deviation)
# Control: rhel_09_431010
rhel_09_431010: false  # Disable SELinux enforcement check
# You'll need to manually set SELinux to permissive mode

## Firewalld - Disabled in favor of Azure NSGs
# Controls: rhel_09_251010, rhel_09_251015, rhel_09_251030
rhel_09_251010: false  # Don't install firewalld
rhel_09_251015: false  # Don't enable firewalld
rhel_09_251020: false  # Don't configure panic mode
rhel_09_251030: false  # Don't configure backend

## AIDE - Not using (you mentioned not needed)
rhel9stig_use_aide: false
rhel9stig_config_aide: false

## Auditd - KEEP ENABLED (Required even with monitoring agents)
rhel9stig_auditd_required: true
# But optimize for Azure Monitor Agent
rhel9stig_audit_conf_overflow_action: syslog
rhel9stig_audit_conf_max_log_file_action: ROTATE

## fapolicyd - Not using (Defender for Endpoint instead)
rhel_09_651010: false  # Don't install fapolicyd
rhel_09_651015: false  # Don't enable fapolicyd service

# ============================================
# CLOUD-SPECIFIC EXCLUSIONS
# ============================================

## USB/Hardware Controls - Not applicable in Azure
rhel_09_272030: false  # USB mass storage
rhel_09_272035: false  # USBGuard install
rhel_09_272040: false  # USBGuard service
rhel_09_291010: false  # USBGuard audit
rhel_09_291020: false  # Bluetooth
rhel_09_291025: false  # WiFi

## Smart Card - Using Azure AD instead
rhel_09_211045: false  # Smart card removal action
rhel_09_211050: false  # Screen lock on smart card removal
rhel_09_611160: false  # OpenSC config
rhel_09_611165: false  # SSSD certificate auth
rhel_09_611175: false  # pcsc-lite install
rhel_09_611180: false  # pcscd service
rhel_09_611185: false  # opensc package
rhel9stig_smartcard_reader: false

## GUI/GNOME - Headless server
rhel9stig_gui_approved: false
rhel_09_211010: false  # GNOME banner
rhel_09_211015: false  # GNOME banner lock
rhel_09_211020: false  # GNOME automount
rhel_09_211030: false  # GNOME autorun
rhel_09_211040: false  # GNOME screensaver
rhel_09_211055: false  # GNOME screen lock
rhel_09_271095: false  # GNOME restart buttons
rhel_09_271100: false  # GNOME user logout
rhel_09_271105: false  # GNOME logout lock
rhel_09_271110: false  # GNOME user list

# ============================================
# AZURE AGENT PROTECTION SETTINGS
# ============================================

## Keep these services/packages for Azure functionality
rhel9stig_nfs_utils_required: true  # May need for Azure Files
rhel9stig_tuned_required: true  # Performance optimization

## Kernel modules - Be careful with these
rhel_09_231010: false  # Don't disable autofs (Azure Files mounting)
rhel_09_231105: false  # Don't disable cramfs (container operations)
rhel_09_231125: false  # Don't disable kdump (Azure handles differently)

## Network settings - Critical for Azure
# Don't modify these kernel parameters that might affect Azure networking
rhel9stig_sysctl_file:
  network: /etc/sysctl.d/99-azure-stig.conf  # Separate file for safety

## SSH - Keep enabled for Azure Serial Console and management
rhel9stig_sshd_required: true
rhel9stig_sshd_config:
  banner_file: /etc/issue
  ciphers: "{{ rhel9stig_dod_ciphers }}"
  clientalivecountmax: 1
  clientaliveinterval: 600
  permitroot: 'no'  # Consider 'yes' if needed for Azure operations
  pubkeyauth: 'yes'  # Required for Azure SSH keys

## Firewall whitelist (if firewalld gets enabled by accident)
rhel9stig_white_list_services:
  - ssh
  - https  # Azure agent communication
  - http   # Azure metadata service

# ============================================
# AZURE-SPECIFIC CONFIGURATIONS
# ============================================

## DNS - Use Azure-provided DNS
rhel9stig_dns_ip4_servers:
  - 168.63.129.16  # Azure DNS

## Time sync - Azure time service
rhel9stig_time_synchronization_servers:
  - time.windows.com  # Azure default time service

## Rsyslog - Configure for Azure Monitor Agent
rhel9stig_rsyslog_server: false  # Unless forwarding to central syslog
rhel9stig_syslog_binary: rsyslogd

## User namespace (important for containers)
# If running containers, set this appropriately
rhel9stig_sysctl_max_user_namespaces: '65536'  # Or '0' if no containers

## Login idle timeout - May need adjustment for long-running operations
rhel9stig_logind_conf_stopsessionidle: '900'

# ============================================
# COMPENSATING CONTROLS DOCUMENTATION
# ============================================

## Audit configuration for compliance documentation
rhel9stig_audit_conf_name_format: hostname
rhel9stig_audit_conf_log_format: ENRICHED  # Better for SIEM integration

## Skip reboot to maintain availability
skip_reboot: true

## Authselect - Be very careful
rhel9stig_add_faillock_without_authselect: true  # Safer approach

# ============================================
# CRITICAL EXCLUSIONS FOR AZURE FABRIC
# ============================================

## Services that must NOT be disabled
# Add to your playbook a task to ensure these are running:
# - waagent (Azure Linux Agent)
# - azuremonitoragent (if using)
# - omiserver (if using OMS)
# - mdsd (if using diagnostics)

## Ports that must remain accessible (not blocked)
# - 80 (HTTP) - Azure metadata service (169.254.169.254)
# - 443 (HTTPS) - Azure services
# - 53 (DNS) - Azure DNS
# - 123 (NTP) - Time sync

## File paths to exclude from AIDE (if you enable it later)
# - /var/lib/waagent/
# - /var/log/azure/
# - /etc/waagent.conf
