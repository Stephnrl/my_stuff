---
# roles/helm_deploy/tasks/main.yml
# Main task orchestration for Helm deployments

- name: Display deployment information
  ansible.builtin.debug:
    msg: |
      Deploying: {{ app_name }}
      Cloud: {{ cloud_provider }}
      Namespace: {{ namespace }}
      Type: {{ deployment_type }}
      Dry Run: {{ dry_run | default(false) }}

- name: Load cloud-specific variables
  ansible.builtin.include_vars:
    file: "{{ cloud_provider }}.yml"
  ignore_errors: true

- name: Load app configuration
  ansible.builtin.include_vars:
    file: "{{ app_config_path }}/config.yml"
  when: app_config_path is defined

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - app_name is defined
      - app_name | length > 0
      - helm.chart is defined
      - helm.chart | length > 0
    fail_msg: "Required variables app_name and helm.chart must be defined"
    success_msg: "Required variables validated"

- name: Run prerequisites
  ansible.builtin.include_tasks: prerequisites.yml
  tags:
    - prerequisites
    - always

- name: Create namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ namespace }}"
        labels: "{{ namespace_labels | combine({'app.kubernetes.io/managed-by': 'ansible'}) }}"
        annotations: "{{ namespace_annotations }}"
    context: "{{ k8s_context | default(omit) }}"
  when: create_namespace | bool
  tags:
    - namespace

- name: Run pre-deployment tasks
  ansible.builtin.include_tasks: pre_deploy.yml
  when: 
    - deployment_type == 'complex' or pre_deploy_manifests | length > 0
  tags:
    - pre-deploy

- name: Run Helm deployment
  ansible.builtin.include_tasks: helm_deploy.yml
  tags:
    - helm
    - deploy

- name: Run post-deployment tasks
  ansible.builtin.include_tasks: post_deploy.yml
  when:
    - deployment_type == 'complex' or post_deploy_manifests | length > 0
  tags:
    - post-deploy

- name: Wait for deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: "{{ namespace }}"
    label_selectors:
      - "app.kubernetes.io/instance={{ app_name }}"
  register: deployment_status
  until: >-
    deployment_status.resources | length > 0 and
    deployment_status.resources | map(attribute='status.readyReplicas') | select('defined') | list | length > 0
  retries: "{{ (wait_timeout | int / 10) | int }}"
  delay: 10
  when: wait_for_resources | bool
  ignore_errors: "{{ not wait_for_resources }}"
  tags:
    - verify

- name: Deployment summary
  ansible.builtin.debug:
    msg: |
      âœ… Deployment Complete
      App: {{ app_name }}
      Namespace: {{ namespace }}
      Helm Release: {{ app_name }}
      Chart: {{ helm.chart }}{% if helm.version is defined %} @ {{ helm.version }}{% endif %}
  tags:
    - summary
