# azure_post_stig.yml
---
- name: Azure-specific STIG adjustments
  hosts: all
  become: true
  tasks:
    - name: Ensure Azure agent services are running
      systemd:
        name: "{{ item }}"
        state: started
        enabled: true
        daemon_reload: true
      loop:
        - waagent
        - azuremonitoragent  # If installed
      ignore_errors: true

    - name: Set SELinux to permissive mode
      selinux:
        policy: targeted
        state: permissive
      when: ansible_selinux.status == "enabled"

    - name: Ensure Azure metadata service is accessible
      lineinfile:
        path: /etc/hosts
        line: "169.254.169.254 metadata.azure.com"
        state: present

    - name: Create Azure-specific sysctl settings
      copy:
        content: |
          # Azure-specific network settings
          # Do not modify these - required for Azure networking
          net.ipv4.tcp_keepalive_time = 120
          net.ipv4.tcp_keepalive_intvl = 30
          net.ipv4.tcp_keepalive_probes = 8
          net.core.netdev_max_backlog = 5000
          net.ipv4.conf.all.send_redirects = 0
          net.ipv4.conf.default.send_redirects = 0
        dest: /etc/sysctl.d/10-azure.conf
        owner: root
        group: root
        mode: '0644'

    - name: Apply Azure sysctl settings
      command: sysctl -p /etc/sysctl.d/10-azure.conf

    - name: Ensure critical Azure directories are excluded from permission changes
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - /var/lib/waagent
        - /var/log/azure
      ignore_errors: true
