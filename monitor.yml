---
- name: Wait for system to come back online
  wait_for:
    host: "{{ inventory_hostname }}"
    port: "{{ ghe_ssh_port }}"
    state: started
    timeout: "{{ connection_timeout }}"
    delay: 30
    
- name: Wait for SSH connection to be ready
  wait_for_connection:
    timeout: 300
    delay: 30
    
- name: Wait for admin console to be available
  wait_for:
    host: "{{ inventory_hostname }}"
    port: "{{ ghe_admin_port }}"
    state: started
    timeout: 300
    delay: 30
    
- name: Monitor migration progress
  shell: |
    migration_complete=false
    timeout=$(({{ migration_timeout }} + $(date +%s)))
    
    while [ $(date +%s) -lt $timeout ] && [ "$migration_complete" = false ]; do
      status=$(ghe-status | grep -i migration || echo "no migrations running")
      echo "$(date): $status"
      
      if echo "$status" | grep -qi "no migrations\|complete\|finished"; then
        migration_complete=true
        echo "$(date): Migrations completed successfully"
      else
        sleep 60
      fi
    done
    
    if [ "$migration_complete" = false ]; then
      echo "$(date): Migration timeout reached"
      exit 1
    fi
  register: migration_monitor
  
- name: Verify system health post-upgrade
  uri:
    url: "https://{{ inventory_hostname }}:{{ ghe_admin_port }}/setup/api/status"
    method: GET
    validate_certs: no
    status_code: 200
    return_content: yes
  register: post_health_check
  retries: "{{ health_check_retries }}"
  delay: "{{ health_check_delay }}"
  
- name: Check all services are operational
  shell: ghe-status
  register: final_services_check
  
- name: Disable maintenance mode
  command: ghe-maintenance -u
  register: maintenance_disable
  
- name: Verify maintenance mode is disabled
  command: ghe-maintenance -q
  register: final_maintenance_status
  until: "'maintenance mode is off' in final_maintenance_status.stdout"
  retries: 5
  delay: 10
  
- name: Log upgrade completion
  lineinfile:
    path: /tmp/upgrade.log
    line: "{{ ansible_date_time.iso8601 }}: Upgrade completed successfully"
    
- name: Cleanup upgrade tracking files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/upgrade-in-progress
    - /tmp/upgrade-job-info
