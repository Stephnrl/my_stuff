@description('Name of the managed identity')
param identityName string

@description('Location for the managed identity')
param location string = resourceGroup().location

@description('Tags to apply to the managed identity')
param tags object = {}

@description('AKS OIDC Issuer URL for federated credential')
param oidcIssuerUrl string

@description('Kubernetes namespace for the service account')
param k8sNamespace string = 'wiz'

@description('Kubernetes service account name')
param k8sServiceAccountName string = 'wiz-service-account'

// Create the managed identity
resource managedIdentity 'Microsoft.ManagedIdentity/userAssignedIdentities@2023-01-31' = {
  name: identityName
  location: location
  tags: tags
}

// Create federated identity credential for workload identity
resource federatedCredential 'Microsoft.ManagedIdentity/userAssignedIdentities/federatedIdentityCredentials@2023-01-31' = {
  parent: managedIdentity
  name: 'wiz-federated-credential'
  properties: {
    issuer: oidcIssuerUrl
    subject: 'system:serviceaccount:${k8sNamespace}:${k8sServiceAccountName}'
    audiences: [
      'api://AzureADTokenExchange'
    ]
  }
}

@description('Client ID of the managed identity')
output clientId string = managedIdentity.properties.clientId

@description('Principal ID of the managed identity')
output principalId string = managedIdentity.properties.principalId

@description('Resource ID of the managed identity')
output resourceId string = managedIdentity.id

@description('Name of the managed identity')
output name string = managedIdentity.name
