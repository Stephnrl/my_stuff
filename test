################################################################################
# Example: Deploying Wiz Kubernetes Connector using the EKS App Module
################################################################################

terraform {
  required_version = ">= 1.3.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = ">= 5.0"
    }
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = ">= 2.20"
    }
    helm = {
      source  = "hashicorp/helm"
      version = ">= 2.10"
    }
  }

  # backend "s3" {
  #   bucket = "your-terraform-state-bucket"
  #   key    = "eks-apps/wiz-connector/terraform.tfstate"
  #   region = "us-east-1"
  # }
}

################################################################################
# Variables
################################################################################

variable "cluster_name" {
  description = "EKS cluster name"
  type        = string
}

variable "aws_region" {
  description = "AWS region"
  type        = string
  default     = "us-east-1"
}

variable "jfrog_url" {
  description = "JFrog Artifactory Helm repository URL"
  type        = string
}

variable "jfrog_username" {
  description = "JFrog username"
  type        = string
}

variable "jfrog_password" {
  description = "JFrog password"
  type        = string
  sensitive   = true
}

variable "wiz_client_id" {
  description = "Wiz API Client ID"
  type        = string
  sensitive   = true
}

variable "wiz_client_secret" {
  description = "Wiz API Client Secret"
  type        = string
  sensitive   = true
}

################################################################################
# Provider Configuration
################################################################################

provider "aws" {
  region = var.aws_region
}

data "aws_eks_cluster" "this" {
  name = var.cluster_name
}

data "aws_eks_cluster_auth" "this" {
  name = var.cluster_name
}

provider "kubernetes" {
  host                   = data.aws_eks_cluster.this.endpoint
  cluster_ca_certificate = base64decode(data.aws_eks_cluster.this.certificate_authority[0].data)
  token                  = data.aws_eks_cluster_auth.this.token
}

provider "helm" {
  kubernetes {
    host                   = data.aws_eks_cluster.this.endpoint
    cluster_ca_certificate = base64decode(data.aws_eks_cluster.this.certificate_authority[0].data)
    token                  = data.aws_eks_cluster_auth.this.token
  }
}

################################################################################
# IAM Policy for Wiz (what the connector needs to access)
################################################################################

data "aws_iam_policy_document" "wiz_connector" {
  # Wiz typically needs read access to various AWS resources
  statement {
    sid    = "WizReadAccess"
    effect = "Allow"
    actions = [
      "ec2:Describe*",
      "eks:Describe*",
      "eks:List*",
      "ecr:GetAuthorizationToken",
      "ecr:BatchCheckLayerAvailability",
      "ecr:GetDownloadUrlForLayer",
      "ecr:BatchGetImage",
    ]
    resources = ["*"]
  }
}

resource "aws_iam_policy" "wiz_connector" {
  name        = "wiz-connector-${var.cluster_name}"
  description = "IAM policy for Wiz Kubernetes Connector"
  policy      = data.aws_iam_policy_document.wiz_connector.json
}

################################################################################
# Deploy Wiz Connector using the Module
################################################################################

module "wiz_connector" {
  source = "../modules/eks-app"

  # General
  app_name     = "wiz-connector"
  cluster_name = var.cluster_name
  namespace    = "wiz"

  # Service Account
  service_account_name = "wiz-connector-sa"

  # Pod Identity - creates IAM role and association
  create_pod_identity_role        = true
  create_pod_identity_association = true
  pod_identity_policy_arns        = [aws_iam_policy.wiz_connector.arn]

  # RBAC - Wiz needs cluster-wide read access
  create_cluster_role = true
  cluster_role_rules = [
    {
      api_groups = [""]
      resources  = ["pods", "nodes", "namespaces", "services", "configmaps", "secrets", "persistentvolumes", "persistentvolumeclaims"]
      verbs      = ["get", "list", "watch"]
    },
    {
      api_groups = ["apps"]
      resources  = ["deployments", "daemonsets", "replicasets", "statefulsets"]
      verbs      = ["get", "list", "watch"]
    },
    {
      api_groups = ["batch"]
      resources  = ["jobs", "cronjobs"]
      verbs      = ["get", "list", "watch"]
    },
    {
      api_groups = ["networking.k8s.io"]
      resources  = ["networkpolicies", "ingresses"]
      verbs      = ["get", "list", "watch"]
    },
    {
      api_groups = ["rbac.authorization.k8s.io"]
      resources  = ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
      verbs      = ["get", "list", "watch"]
    },
    {
      api_groups = ["policy"]
      resources  = ["podsecuritypolicies"]
      verbs      = ["get", "list", "watch"]
    }
  ]

  # Secrets Store CSI - fetch Wiz credentials from Secrets Manager
  create_secret_provider_class = true
  sync_as_kubernetes_secret    = true
  secrets_manager_secrets = [
    {
      secret_name = "wiz/api-credentials"
      key         = "client-id"
      alias       = "wiz-client-id"
    },
    {
      secret_name = "wiz/api-credentials"
      key         = "client-secret"
      alias       = "wiz-client-secret"
    }
  ]

  # Helm - deploy from internal JFrog
  deploy_helm_chart        = true
  helm_repository          = var.jfrog_url
  helm_repository_username = var.jfrog_username
  helm_repository_password = var.jfrog_password
  helm_chart_name          = "wiz-kubernetes-connector"
  helm_chart_version       = "2.0.0" # Specify your version
  helm_timeout             = 600
  helm_atomic              = true

  # Helm values
  helm_values = [
    yamlencode({
      global = {
        clusterName = var.cluster_name
      }
      serviceAccount = {
        create = false
        name   = "wiz-connector-sa"
      }
      # Use the synced Kubernetes secret from CSI driver
      existingSecret = "wiz-connector-k8s-secret"
    })
  ]

  # Additional overrides
  helm_set_values = [
    {
      name  = "resources.requests.memory"
      value = "256Mi"
    },
    {
      name  = "resources.requests.cpu"
      value = "100m"
    }
  ]

  tags = {
    Environment = "production"
    Application = "wiz-connector"
    ManagedBy   = "terraform"
  }
}

################################################################################
# Outputs
################################################################################

output "wiz_namespace" {
  value = module.wiz_connector.namespace
}

output "wiz_service_account" {
  value = module.wiz_connector.service_account_name
}

output "wiz_pod_identity_role_arn" {
  value = module.wiz_connector.pod_identity_role_arn
}

output "wiz_helm_release_status" {
  value = module.wiz_connector.helm_release_status
}
