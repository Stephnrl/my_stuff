################################################################################
# IAM Role for GitHub Actions (OIDC)
# This role allows GitHub Actions to deploy to AWS via OIDC federation
################################################################################

resource "aws_iam_role" "github_actions" {
  name = "wiz-connector-github-actions-${var.environment}"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = {
          Federated = data.aws_iam_openid_connect_provider.github.arn
        }
        Action = "sts:AssumeRoleWithWebIdentity"
        Condition = {
          StringEquals = {
            "token.actions.githubusercontent.com:aud" = "sts.amazonaws.com"
          }
          StringLike = {
            # Trust the specific repo and environment
            "token.actions.githubusercontent.com:sub" = "repo:${var.github_org}/${var.github_repo}:environment:${var.github_environment}"
          }
        }
      }
    ]
  })

  tags = merge(var.additional_tags, {
    Name = "wiz-connector-github-actions-${var.environment}"
  })
}

# Policy for GitHub Actions role - permissions needed to run Terraform
resource "aws_iam_role_policy" "github_actions" {
  name = "wiz-connector-github-actions-policy"
  role = aws_iam_role.github_actions.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      # EKS permissions
      {
        Effect = "Allow"
        Action = [
          "eks:DescribeCluster",
          "eks:ListClusters",
          "eks:DescribeAddon",
          "eks:ListAddons",
          "eks:CreateAddon",
          "eks:UpdateAddon",
          "eks:DeleteAddon",
          "eks:DescribePodIdentityAssociation",
          "eks:CreatePodIdentityAssociation",
          "eks:DeletePodIdentityAssociation",
          "eks:ListPodIdentityAssociations"
        ]
        Resource = "*"
      },
      # IAM permissions for managing Pod Identity role
      {
        Effect = "Allow"
        Action = [
          "iam:CreateRole",
          "iam:DeleteRole",
          "iam:GetRole",
          "iam:UpdateRole",
          "iam:TagRole",
          "iam:UntagRole",
          "iam:ListRoleTags",
          "iam:PutRolePolicy",
          "iam:GetRolePolicy",
          "iam:DeleteRolePolicy",
          "iam:ListRolePolicies",
          "iam:AttachRolePolicy",
          "iam:DetachRolePolicy",
          "iam:ListAttachedRolePolicies",
          "iam:PassRole"
        ]
        Resource = [
          "arn:${data.aws_partition.current.partition}:iam::${data.aws_caller_identity.current.account_id}:role/wiz-connector-*"
        ]
      },
      # Secrets Manager permissions
      {
        Effect = "Allow"
        Action = [
          "secretsmanager:CreateSecret",
          "secretsmanager:DeleteSecret",
          "secretsmanager:DescribeSecret",
          "secretsmanager:GetSecretValue",
          "secretsmanager:PutSecretValue",
          "secretsmanager:UpdateSecret",
          "secretsmanager:TagResource",
          "secretsmanager:UntagResource",
          "secretsmanager:ListSecrets"
        ]
        Resource = [
          "arn:${data.aws_partition.current.partition}:secretsmanager:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:secret:wiz-connector/*"
        ]
      },
      # S3 permissions for Terraform state
      {
        Effect = "Allow"
        Action = [
          "s3:GetObject",
          "s3:PutObject",
          "s3:DeleteObject",
          "s3:ListBucket"
        ]
        Resource = [
          "arn:${data.aws_partition.current.partition}:s3:::${var.terraform_state_bucket}",
          "arn:${data.aws_partition.current.partition}:s3:::${var.terraform_state_bucket}/*"
        ]
      },
      # DynamoDB for state locking (optional but recommended)
      {
        Effect = "Allow"
        Action = [
          "dynamodb:GetItem",
          "dynamodb:PutItem",
          "dynamodb:DeleteItem"
        ]
        Resource = "arn:${data.aws_partition.current.partition}:dynamodb:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:table/terraform-state-lock"
      }
    ]
  })
}

################################################################################
# IAM Role for Wiz Connector Pod (Pod Identity)
# This role is assumed by the Wiz connector pod via EKS Pod Identity
################################################################################

resource "aws_iam_role" "wiz_connector_pod" {
  name = "wiz-connector-pod-${var.environment}"

  # Pod Identity trust policy
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Principal = {
          Service = "pods.eks.amazonaws.com"
        }
        Action = [
          "sts:AssumeRole",
          "sts:TagSession"
        ]
      }
    ]
  })

  tags = merge(var.additional_tags, {
    Name = "wiz-connector-pod-${var.environment}"
  })
}

# Policy for Wiz connector pod - access to Secrets Manager
resource "aws_iam_role_policy" "wiz_connector_secrets" {
  name = "wiz-connector-secrets-access"
  role = aws_iam_role.wiz_connector_pod.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "secretsmanager:GetSecretValue",
          "secretsmanager:DescribeSecret"
        ]
        Resource = [
          aws_secretsmanager_secret.wiz_client_id.arn,
          aws_secretsmanager_secret.wiz_client_secret.arn
        ]
      }
    ]
  })
}

################################################################################
# EKS Pod Identity Association
# Links the IAM role to the Kubernetes service account
################################################################################

resource "aws_eks_pod_identity_association" "wiz_connector" {
  cluster_name    = var.eks_cluster_name
  namespace       = var.wiz_namespace
  service_account = var.wiz_service_account_name
  role_arn        = aws_iam_role.wiz_connector_pod.arn

  tags = merge(var.additional_tags, {
    Name = "wiz-connector-pod-identity-${var.environment}"
  })
}
