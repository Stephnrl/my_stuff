kubectl get csidriver
# Should show: secrets-store.csi.k8s.io
```

### 2. Azure Key Vault

**Created via Bicep (Infrastructure Deployment):**
- Azure Key Vault instance
- Private endpoint configuration
- Wiz secrets stored (client-id, client-token)

**Required Secrets:**
| Secret Name | Description | Source |
|-------------|-------------|--------|
| `wiz-client-id` | Wiz connector client ID | Generated from Wiz portal |
| `wiz-client-token` | Wiz connector authentication token | Generated from Wiz portal |

### 3. User Managed Identity (UMI)

**Created via Bicep:**
- User Managed Identity for workload identity
- Federated credential configured for AKS OIDC
- Key Vault access permissions (Secret Read)

**Federated Credential Subject Format:**
```
system:serviceaccount:<namespace>:<service-account-name>
```

**Example:**
```
system:serviceaccount:wiz-connector:wiz-connector-sa
```

## Azure Permissions

### Service Principal (for GitHub Actions)

The GitHub Actions workflow requires a Service Principal with the following roles on the target AKS cluster:

| Role Name | Purpose |
|-----------|---------|
| `Reader` | Read cluster configuration |
| `Azure Kubernetes Service Cluster User Role` | Get cluster user credentials |
| `Azure Kubernetes Service Contributor Role` | Manage cluster resources |
| `Azure Kubernetes Service RBAC Admin` | Create namespaces and RBAC resources |
| `Azure Kubernetes Service RBAC Writer` | Apply Kubernetes manifests |
| `Deployment Contributor` | Deploy resources (if managing infrastructure) |

**Note on Permissions:** This is a comprehensive set for full deployment automation. Consider reviewing if you can scope down further based on least privilege principles.

**How These Are Created:**
These permissions are automatically configured during the landing zone onboarding process via Terraform, which creates the GitHub repository, Service Principal, and configures GitHub environment secrets.

## GitHub Configuration

### 1. GitHub App for Ansible Repository Access

**Required Setup:**
- GitHub App created with access to `snc-devsecops/devsecops-ansible`
- App credentials stored as secrets in deployment repository

**Required Secrets:**
| Secret Name | Description |
|-------------|-------------|
| `ANSIBLE_APP_ID` | GitHub App ID |
| `ANSIBLE_APP_PRIVATE_KEY` | GitHub App private key (PEM format) |

### 2. GitHub Environment Secrets

**Created by Onboarding Terraform:**
| Secret Name | Description | Source |
|-------------|-------------|--------|
| `AZURE_CLIENT_ID` | Service Principal client ID | Terraform output |
| `AZURE_TENANT_ID` | Azure tenant ID | Terraform output |
| `AZURE_SUBSCRIPTION_ID` | Azure subscription ID | Terraform output |

### 3. GitHub Environment Variables

| Variable Name | Description | Example |
|---------------|-------------|---------|
| `AKS_RESOURCE_GROUP` | AKS cluster resource group | `rg-aks-prod-eastus` |
| `AKS_CLUSTER_NAME` | AKS cluster name | `aks-prod-eastus-001` |
| `KEY_VAULT_NAME` | Key Vault name | `kv-wiz-prod-eastus` |
| `UMI_CLIENT_ID` | User Managed Identity client ID | `12345678-abcd-...` |
| `WIZ_NAMESPACE` | Kubernetes namespace for Wiz | `wiz-connector` |

### 4. GitHub Runners

**Required:**
- Self-hosted internal GitHub Actions runners
- Runners must have network access to:
  - Azure API endpoints
  - AKS cluster API server
  - JFrog Helm proxy

## Wiz Configuration

### 1. Wiz Portal Access

**Steps to Generate Connector Credentials:**

1. Log in to Wiz portal
2. Navigate to: **Settings** → **Connectors** → **Kubernetes**
3. Click **Add Connector**
4. Select **Azure AKS**
5. Generate connector credentials:
   - Client ID
   - Client Token
6. **Important**: Save these credentials immediately - the token is only shown once

### 2. Initial values.yaml from Wiz

**Note:** Wiz provides a generic `values.yaml` during connector setup. **Do not use this directly.** It does not align with our security standards.

Instead, use the template provided in this repository's `values.yaml` which integrates with:
- Key Vault CSI driver
- Pre-created service accounts
- Workload identity

## JFrog Helm Proxy

**Requirements:**
- JFrog Artifactory configured as Helm proxy
- Wiz Helm repository (`wiz-sec`) synced to JFrog
- Credentials for Ansible to access JFrog

**Repository URL:**
```
https://<jfrog-instance>/artifactory/helm-remote/
```

## Ansible Repository Access

**Repository:** `snc-devsecops/devsecops-ansible`

**Required Structure:**
```
devsecops-ansible/
├── playbooks/
│   └── aks/
│       └── aks_deploy.yml
└── roles/
    └── aks/
        └── deploy/
            ├── tasks/
            │   └── main.yml
            ├── templates/
            │   ├── secret-provider-class.yml.j2
            │   └── service-account.yml.j2
            └── defaults/
                └── main.yml
