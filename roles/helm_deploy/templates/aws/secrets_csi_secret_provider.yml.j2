---
# templates/aws/secrets_csi_secret_provider.yml.j2
# SecretProviderClass for AWS Secrets Manager CSI Driver
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: {{ app_name }}-aws-secrets
  namespace: {{ namespace }}
  labels:
    app.kubernetes.io/name: {{ app_name }}
    app.kubernetes.io/component: secret-provider
    app.kubernetes.io/managed-by: ansible
spec:
  provider: aws
  parameters:
    region: {{ aws.region }}
    objects: |
{% for secret in secrets %}
      - objectName: "{{ aws.secrets_manager_prefix | default('') }}{{ secret.aws_secret | default(secret.name) }}"
        objectType: "secretsmanager"
{% if secret.object_alias is defined %}
        objectAlias: "{{ secret.object_alias }}"
{% endif %}
{% if secret.jmes_path is defined %}
        jmesPath:
{% for path in secret.jmes_path %}
          - path: "{{ path.path }}"
            objectAlias: "{{ path.alias }}"
{% endfor %}
{% endif %}
{% endfor %}
{% if secrets | selectattr('sync_as_secret', 'defined') | selectattr('sync_as_secret') | list | length > 0 or secrets | rejectattr('sync_as_secret', 'defined') | list | length > 0 %}
  secretObjects:
{% for secret in secrets %}
{% if secret.sync_as_secret | default(true) %}
    - secretName: {{ secret.name }}
      type: {{ secret.type | default('Opaque') }}
      data:
{% if secret.jmes_path is defined %}
{% for path in secret.jmes_path %}
        - objectName: {{ path.alias }}
          key: {{ path.key | default(path.alias) }}
{% endfor %}
{% else %}
        - objectName: {{ secret.object_alias | default(aws.secrets_manager_prefix | default('') ~ (secret.aws_secret | default(secret.name))) }}
          key: {{ secret.key | default('value') }}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}
