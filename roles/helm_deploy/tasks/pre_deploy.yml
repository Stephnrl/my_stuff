---
# roles/helm_deploy/tasks/pre_deploy.yml
# Pre-deployment tasks: service accounts, CSI drivers, secrets

- name: Pre-deployment tasks
  ansible.builtin.debug:
    msg: "Running pre-deployment tasks for {{ app_name }}"

# Service Account creation
- name: Create Service Account
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'common/service_account.yml.j2') | from_yaml }}"
    context: "{{ k8s_context | default(omit) }}"
  when: service_account.create | bool

# Azure-specific pre-deployment
- name: Azure pre-deployment setup
  when: 
    - cloud_provider == 'azure'
    - csi_driver.enabled | default(false)
  block:
    - name: Create Azure Workload Identity Service Account
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'azure/service_account.yml.j2') | from_yaml }}"
        context: "{{ k8s_context | default(omit) }}"
      when: azure.use_workload_identity | default(true)

    - name: Create SecretProviderClass for Azure Key Vault
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'azure/keyvault_csi_secret_provider.yml.j2') | from_yaml }}"
        context: "{{ k8s_context | default(omit) }}"
      when: 
        - azure.keyvault_name is defined
        - secrets | length > 0

# AWS-specific pre-deployment
- name: AWS pre-deployment setup
  when:
    - cloud_provider == 'aws'
    - csi_driver.enabled | default(false)
  block:
    - name: Create AWS IRSA Service Account
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'aws/service_account.yml.j2') | from_yaml }}"
        context: "{{ k8s_context | default(omit) }}"
      when: aws.role_arn is defined

    - name: Create SecretProviderClass for AWS Secrets Manager
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'aws/secrets_csi_secret_provider.yml.j2') | from_yaml }}"
        context: "{{ k8s_context | default(omit) }}"
      when: secrets | length > 0

# Apply ConfigMaps
- name: Create ConfigMaps
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: "{{ item.name }}"
        namespace: "{{ namespace }}"
        labels:
          app.kubernetes.io/name: "{{ app_name }}"
          app.kubernetes.io/managed-by: ansible
      data: "{{ item.data }}"
    context: "{{ k8s_context | default(omit) }}"
  loop: "{{ configmaps }}"
  when: configmaps | length > 0

# Apply custom pre-deployment manifests
- name: Process pre-deployment manifests
  block:
    - name: Render and apply pre-deployment manifests (j2 templates)
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', item) | from_yaml_all | list }}"
        context: "{{ k8s_context | default(omit) }}"
      loop: "{{ pre_deploy_manifests | select('match', '.*\\.j2$') | list }}"
      when: pre_deploy_manifests | select('match', '.*\\.j2$') | list | length > 0

    - name: Apply pre-deployment manifests (raw yaml)
      kubernetes.core.k8s:
        state: present
        src: "{{ item }}"
        context: "{{ k8s_context | default(omit) }}"
      loop: "{{ pre_deploy_manifests | reject('match', '.*\\.j2$') | list }}"
      when: pre_deploy_manifests | reject('match', '.*\\.j2$') | list | length > 0
  when: pre_deploy_manifests | length > 0

# Wait for CSI-synced secrets if using CSI driver
- name: Wait for CSI secrets to sync
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    namespace: "{{ namespace }}"
    name: "{{ item.name }}"
  register: secret_check
  until: secret_check.resources | length > 0
  retries: 30
  delay: 10
  loop: "{{ secrets }}"
  when:
    - csi_driver.enabled | default(false)
    - secrets | length > 0
    - item.sync_as_secret | default(true)
  ignore_errors: true
