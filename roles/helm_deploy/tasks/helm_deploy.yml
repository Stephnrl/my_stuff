---
# roles/helm_deploy/tasks/helm_deploy.yml
# Helm chart deployment tasks

- name: Helm deployment
  ansible.builtin.debug:
    msg: "Deploying Helm chart {{ helm.chart }} as release {{ app_name }}"

# Build values files list
- name: Set primary values file path
  ansible.builtin.set_fact:
    helm_values_files: >-
      {{
        ([app_config_path ~ '/' ~ helm.values_file] if app_config_path is defined else [])
        + (helm.additional_values_files | default([]))
      }}

# Template values file if it's a j2 template
- name: Process templated values files
  block:
    - name: Create temp directory for rendered values
      ansible.builtin.tempfile:
        state: directory
        suffix: helm_values
      register: temp_values_dir

    - name: Render j2 values files
      ansible.builtin.template:
        src: "{{ item }}"
        dest: "{{ temp_values_dir.path }}/{{ item | basename | regex_replace('\\.j2$', '') }}"
        mode: '0644'
      loop: "{{ helm_values_files | select('match', '.*\\.j2$') | list }}"
      register: rendered_values

    - name: Update values files list with rendered paths
      ansible.builtin.set_fact:
        helm_values_files_processed: >-
          {{
            helm_values_files | reject('match', '.*\\.j2$') | list
            + rendered_values.results | default([]) | map(attribute='dest') | select('defined') | list
          }}
  when: helm_values_files | select('match', '.*\\.j2$') | list | length > 0

- name: Set final values files (no j2 processing needed)
  ansible.builtin.set_fact:
    helm_values_files_processed: "{{ helm_values_files }}"
  when: helm_values_files | select('match', '.*\\.j2$') | list | length == 0

# Debug: Show what will be deployed
- name: Display Helm deployment details
  ansible.builtin.debug:
    msg: |
      Release: {{ app_name }}
      Chart: {{ helm.chart }}
      Version: {{ helm.version | default('latest') }}
      Namespace: {{ namespace }}
      Values Files: {{ helm_values_files_processed | join(', ') }}
      Set Values: {{ helm.set_values | default({}) | to_nice_yaml }}
  when: debug_mode | default(false)

# Dry run if requested
- name: Helm dry run
  ansible.builtin.command: >
    helm upgrade --install {{ app_name }} {{ helm.chart }}
    --namespace {{ namespace }}
    {% if helm.version is defined and helm.version | length > 0 %}
    --version {{ helm.version }}
    {% endif %}
    {% for values_file in helm_values_files_processed %}
    -f {{ values_file }}
    {% endfor %}
    {% for key, value in (helm.set_values | default({})).items() %}
    --set {{ key }}={{ value }}
    {% endfor %}
    {% for key, value in (helm.set_string_values | default({})).items() %}
    --set-string {{ key }}={{ value }}
    {% endfor %}
    --dry-run
  register: helm_dry_run
  changed_when: false
  when: dry_run | default(false)

- name: Show dry run output
  ansible.builtin.debug:
    var: helm_dry_run.stdout_lines
  when: 
    - dry_run | default(false)
    - helm_dry_run is defined

# Actual Helm deployment
- name: Deploy Helm chart
  kubernetes.core.helm:
    name: "{{ app_name }}"
    chart_ref: "{{ helm.chart }}"
    chart_version: "{{ helm.version | default(omit) }}"
    release_namespace: "{{ namespace }}"
    create_namespace: "{{ helm.create_namespace | default(true) }}"
    values_files: "{{ helm_values_files_processed if helm_values_files_processed | length > 0 else omit }}"
    values: "{{ helm.set_values | default(omit) }}"
    wait: "{{ helm.wait | default(true) }}"
    timeout: "{{ helm.timeout | default('10m') }}"
    atomic: "{{ helm.atomic | default(true) }}"
    dependency_update: "{{ helm.dependency_update | default(true) }}"
    history_max: "{{ max_history | default(5) }}"
    context: "{{ k8s_context | default(omit) }}"
    state: present
  register: helm_result
  when: not (dry_run | default(false))

- name: Display Helm deployment result
  ansible.builtin.debug:
    msg: |
      Helm deployment status: {{ helm_result.status | default('completed') }}
      {% if helm_result.changed %}
      Changes applied: Yes
      {% endif %}
  when: 
    - not (dry_run | default(false))
    - helm_result is defined

# Cleanup temp directory
- name: Clean up temporary values directory
  ansible.builtin.file:
    path: "{{ temp_values_dir.path }}"
    state: absent
  when: temp_values_dir is defined and temp_values_dir.path is defined
