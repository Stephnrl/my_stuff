---
# roles/helm_deploy/tasks/prerequisites.yml
# Prerequisites: tool checks, authentication, and setup

- name: Check required tools
  block:
    - name: Check kubectl
      ansible.builtin.command: kubectl version --client
      register: kubectl_check
      changed_when: false
      failed_when: kubectl_check.rc != 0

    - name: Check helm
      ansible.builtin.command: helm version --short
      register: helm_check
      changed_when: false
      failed_when: helm_check.rc != 0

    - name: Display tool versions
      ansible.builtin.debug:
        msg: |
          kubectl: {{ kubectl_check.stdout | regex_search('v[0-9.]+') }}
          helm: {{ helm_check.stdout }}
      when: debug_mode | default(false)

# Azure Authentication
- name: Azure authentication
  when: cloud_provider == 'azure'
  block:
    - name: Check Azure CLI
      ansible.builtin.command: az version
      register: az_check
      changed_when: false
      failed_when: az_check.rc != 0

    - name: Login to Azure (Service Principal)
      ansible.builtin.command: >
        az login --service-principal
        -u {{ lookup('env', 'AZURE_CLIENT_ID') }}
        -p {{ lookup('env', 'AZURE_CLIENT_SECRET') }}
        --tenant {{ lookup('env', 'AZURE_TENANT_ID') }}
      when: 
        - lookup('env', 'AZURE_CLIENT_ID') | length > 0
        - lookup('env', 'AZURE_CLIENT_SECRET') | length > 0
      changed_when: false
      no_log: true

    - name: Get AKS credentials
      ansible.builtin.command: >
        az aks get-credentials
        --resource-group {{ azure.resource_group }}
        --name {{ azure.aks_cluster }}
        --overwrite-existing
      when:
        - azure.resource_group is defined
        - azure.aks_cluster is defined
      changed_when: false

# AWS Authentication
- name: AWS authentication
  when: cloud_provider == 'aws'
  block:
    - name: Check AWS CLI
      ansible.builtin.command: aws --version
      register: aws_check
      changed_when: false
      failed_when: aws_check.rc != 0

    - name: Update kubeconfig for EKS
      ansible.builtin.command: >
        aws eks update-kubeconfig
        --name {{ aws.eks_cluster }}
        --region {{ aws.region }}
      when:
        - aws.eks_cluster is defined
        - aws.region is defined
      changed_when: false

# Verify cluster connectivity
- name: Verify Kubernetes connectivity
  kubernetes.core.k8s_cluster_info:
    context: "{{ k8s_context | default(omit) }}"
  register: cluster_info
  failed_when: cluster_info.connection.host is not defined

- name: Display cluster info
  ansible.builtin.debug:
    msg: "Connected to cluster: {{ cluster_info.connection.host }}"
  when: debug_mode | default(false)

# Add Helm repository if specified
- name: Add Helm repository
  kubernetes.core.helm_repository:
    name: "{{ helm.repo_name }}"
    repo_url: "{{ helm.repo_url }}"
    state: present
  when:
    - helm.repo_name is defined
    - helm.repo_url is defined
    - helm.repo_name | length > 0
    - helm.repo_url | length > 0

- name: Update Helm repositories
  ansible.builtin.command: helm repo update
  changed_when: false
  when:
    - helm.repo_url is defined
    - helm.repo_url | length > 0
