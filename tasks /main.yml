---
- name: Azure VM Disk Snapshot Workflow
  block:
    - name: Validate Azure authentication
      fail:
        msg: "Azure subscription ID is required"
      when: azure_subscription_id is not defined or azure_subscription_id == ""

    - name: Include disk discovery tasks
      include_tasks: discover.yml
      tags:
        - discovery
        - azure_snapshot

    - name: Include snapshot creation tasks
      include_tasks: snapshot.yml
      tags:
        - create_snapshots
        - azure_snapshot

    - name: Include cleanup tasks
      include_tasks: cleanup.yml
      when: cleanup_old_snapshots | bool
      tags:
        - cleanup
        - azure_snapshot

  rescue:
    - name: Handle snapshot failures
      debug:
        msg: "Snapshot creation failed: {{ ansible_failed_result.msg }}"
      
    - name: Fail the play if snapshots are mandatory
      fail:
        msg: "Critical: Unable to create VM snapshots before upgrade"
      when: snapshot_required | default(true)
