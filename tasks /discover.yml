---
- name: Discover Azure VM configuration
  block:
    - name: Get VM information
      azure.azcollection.azure_rm_virtualmachine_info:
        resource_group: "{{ azure_resource_group }}"
        name: "{{ vm_name | default(ansible_hostname) }}"
        subscription_id: "{{ azure_subscription_id }}"
      register: vm_info
      delegate_to: localhost

    - name: Verify VM was found
      fail:
        msg: "VM '{{ vm_name | default(ansible_hostname) }}' not found in resource group '{{ azure_resource_group }}'"
      when: vm_info.vms | length == 0

    - name: Get disks managed by our VM
      azure.azcollection.azure_rm_manageddisk_info:
        managed_by: "{{ vm_info.vms[0].id }}"
        subscription_id: "{{ azure_subscription_id }}"
      register: vm_disks_result
      delegate_to: localhost

    - name: Extract VM and disk details
      set_fact:
        vm_details: "{{ vm_info.vms[0] }}"
        all_vm_disks: "{{ vm_disks_result.azure_managed_disk }}"

    - name: Categorize disks by type
      set_fact:
        os_disk_info: "{{ all_vm_disks | selectattr('os_type', 'defined') | first | default({}) }}"
        data_disks_info: "{{ all_vm_disks | rejectattr('os_type', 'defined') | list }}"

    - name: Display discovered disks
      debug:
        msg: |
          Discovered VM: {{ vm_details.name }}
          {% if os_disk_info %}
          OS Disk: {{ os_disk_info.name }} ({{ os_disk_info.id }})
          - Size: {{ os_disk_info.disk_size_gb }}GB
          - Type: {{ os_disk_info.storage_account_type }}
          - OS: {{ os_disk_info.os_type }}
          {% else %}
          OS Disk: Not found
          {% endif %}
          Data Disks: {{ data_disks_info | length }} found
          {% for disk in data_disks_info %}
          - {{ disk.name }}: {{ disk.id }}
            - Size: {{ disk.disk_size_gb }}GB
            - Type: {{ disk.storage_account_type }}
          {% endfor %}

    - name: Create disk inventory
      set_fact:
        disks_to_snapshot: |
          {%- set disk_list = [] -%}
          {%- if create_os_snapshot and os_disk_info -%}
            {%- set _ = disk_list.append({
                'name': os_disk_info.name,
                'id': os_disk_info.id,
                'type': 'os',
                'os_type': os_disk_info.os_type,
                'size_gb': os_disk_info.disk_size_gb,
                'storage_type': os_disk_info.storage_account_type
            }) -%}
          {%- endif -%}
          {%- if create_data_snapshots -%}
            {%- for disk in data_disks_info -%}
              {%- set _ = disk_list.append({
                  'name': disk.name,
                  'id': disk.id,
                  'type': 'data',
                  'size_gb': disk.disk_size_gb,
                  'storage_type': disk.storage_account_type
              }) -%}
            {%- endfor -%}
          {%- endif -%}
          {{ disk_list }}

    - name: Verify disks found
      fail:
        msg: "No disks found to snapshot. Check create_os_snapshot and create_data_snapshots variables."
      when: disks_to_snapshot | length == 0

    - name: Display snapshot inventory
      debug:
        msg: |
          Disks to snapshot: {{ disks_to_snapshot | length }}
          {% for disk in disks_to_snapshot %}
          - {{ disk.name }} ({{ disk.type }}): {{ disk.size_gb }}GB
          {% endfor %}
