---
# roles/monitoring/elastic_agent/tasks/configure.yml

- name: Determine configuration mode
  ansible.builtin.set_fact:
    elastic_config_mode: "{{ 'fleet' if elastic_agent_fleet_url is defined and elastic_agent_fleet_url else 'standalone' }}"

- name: Display configuration mode
  ansible.builtin.debug:
    msg: "Configuring Elastic Agent in {{ elastic_config_mode }} mode"

- name: Configure Fleet-managed Elastic Agent
  when: elastic_config_mode == 'fleet'
  block:
    - name: Check if agent is already enrolled
      ansible.builtin.command: elastic-agent status
      register: agent_status
      failed_when: false
      changed_when: false

    - name: Check enrollment status
      ansible.builtin.set_fact:
        is_enrolled: "{{ 'Connected' in agent_status.stdout or 'healthy' in agent_status.stdout }}"
      when: agent_status.rc == 0

    - name: Enroll Elastic Agent with Fleet
      ansible.builtin.command: >
        elastic-agent enroll
        --url={{ elastic_agent_fleet_url }}
        --enrollment-token={{ elastic_agent_enrollment_token }}
        {{ '--force' if elastic_agent_force_enroll else '' }}
        {{ '--insecure' if elastic_agent_fleet_insecure else '' }}
        --non-interactive
      when: 
        - not (is_enrolled | default(false))
        - elastic_agent_enrollment_token is defined
      register: enrollment_result
      notify: restart elastic-agent

    - name: Display enrollment result
      ansible.builtin.debug:
        msg: "Enrollment completed successfully"
      when: enrollment_result is changed

- name: Configure Standalone Elastic Agent
  when: elastic_config_mode == 'standalone'
  block:
    - name: Ensure Elastic Agent config directory exists
      ansible.builtin.file:
        path: /opt/Elastic/Agent
        state: directory
        mode: '0750'
        owner: root
        group: root

    - name: Deploy standalone elastic-agent.yml configuration
      ansible.builtin.template:
        src: elastic-agent.yml.j2
        dest: /opt/Elastic/Agent/elastic-agent.yml
        mode: '0640'
        owner: root
        group: root
        backup: yes
      notify: restart elastic-agent

    - name: Validate configuration syntax
      ansible.builtin.command: elastic-agent validate -c /opt/Elastic/Agent/elastic-agent.yml
      register: config_validation
      failed_when: config_validation.rc != 0
      changed_when: false

- name: Configure agent logging
  ansible.builtin.template:
    src: logging.yml.j2
    dest: /opt/Elastic/Agent/logging.yml
    mode: '0640'
    owner: root
    group: root
    backup: yes
  when: elastic_agent_custom_logging | default(false)
  notify: restart elastic-agent

- name: Set agent log level
  ansible.builtin.lineinfile:
    path: /opt/Elastic/Agent/elastic-agent.yml
    regexp: '^(\s*)#?\s*level:'
    line: '  level: {{ elastic_agent_log_level }}'
    state: present
  when: 
    - elastic_config_mode == 'standalone'
    - elastic_agent_log_level is defined
  notify: restart elastic-agent
