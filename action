name: 'Fetch Key Vault CSR'
description: 'Retrieves a CSR already initiated by Terraform'
inputs:
  keyvault_name:
    required: true
  cert_name:
    required: true

runs:
  using: "composite"
  steps:
    - name: Fetch Pending CSR
      shell: pwsh
      run: |
        # Get the operation status from Azure
        $op = Get-AzKeyVaultCertificateOperation `
                -VaultName "${{ inputs.keyvault_name }}" `
                -Name "${{ inputs.cert_name }}"

        if ($op.Status -eq "inProgress") {
            # Wrap in standard PEM headers
            $csr = "-----BEGIN CERTIFICATE REQUEST-----`n$($op.Csr)`n-----END CERTIFICATE REQUEST-----"
            $csr | Out-File "request.csr" -Encoding ascii
            Write-Host "CSR successfully fetched and saved to request.csr"
        } else {
            Write-Error "Certificate is not in a pending state. Current status: $($op.Status)"
            exit 1
        }
