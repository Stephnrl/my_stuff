name: 'Terraform Runner'
description: 'Sets up Terraform, runs fmt, init, validate, plan, and optional apply'
inputs:
  terraform_version:
    description: 'The version of Terraform to use'
    required: false
    default: 'latest'
  working_directory:
    description: 'The directory containing the Terraform configuration'
    required: false
    default: '.'
  apply:
    description: 'Set to true to apply the changes'
    required: false
    default: 'false'
  github_token:
    description: 'The GitHub token (needed for setup-terraform to avoid rate limits)'
    required: false

runs:
  using: "composite"
  steps:
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ inputs.terraform_version }}
        cli_config_credentials_token: ${{ inputs.github_token }}

    - name: Terraform Format Check
      run: terraform fmt -check -recursive
      shell: bash
      working-directory: ${{ inputs.working_directory }}

    - name: Terraform Init
      run: terraform init
      shell: bash
      working-directory: ${{ inputs.working_directory }}

    - name: Terraform Validate
      run: terraform validate
      shell: bash
      working-directory: ${{ inputs.working_directory }}

    - name: Terraform Plan
      id: plan
      run: |
        terraform plan -out=tfplan -input=false
      shell: bash
      working-directory: ${{ inputs.working_directory }}

    - name: Terraform Apply
      if: inputs.apply == 'true'
      run: terraform apply -auto-approve -input=false tfplan
      shell: bash
      working-directory: ${{ inputs.working_directory }}
