---
# =============================================================================
# Golden Image Provisioning Playbook
# =============================================================================
# This playbook is executed by Packer to configure the base AMI.
# It applies standardized configuration, security hardening, and monitoring.
# =============================================================================

- name: Configure Golden AMI
  hosts: all
  become: yes
  gather_facts: yes
  
  vars:
    # AMI metadata (passed from Packer)
    ami_name: "{{ ami_name | default('golden-ami') }}"
    ami_version: "{{ ami_version | default('1.0.0') }}"
    environment: "{{ environment | default('lab') }}"
    
    # Configuration options
    install_cloudwatch_agent: true
    install_ssm_agent: true
    enable_security_hardening: true
    
  pre_tasks:
    - name: Display build information
      ansible.builtin.debug:
        msg: |
          ============================================
          Building Golden AMI
          --------------------------------------------
          AMI Name:    {{ ami_name }}
          Version:     {{ ami_version }}
          Environment: {{ environment }}
          OS:          {{ ansible_distribution }} {{ ansible_distribution_version }}
          Kernel:      {{ ansible_kernel }}
          ============================================
    
    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: auto
  
  roles:
    - role: base
      tags: [base, always]
    
    - role: security
      tags: [security, hardening]
      when: enable_security_hardening | bool
    
    - role: monitoring
      tags: [monitoring, cloudwatch]
      when: install_cloudwatch_agent | bool
  
  post_tasks:
    - name: Create AMI metadata file
      ansible.builtin.copy:
        content: |
          AMI_NAME={{ ami_name }}
          AMI_VERSION={{ ami_version }}
          BUILD_DATE={{ ansible_date_time.iso8601 }}
          BASE_OS={{ ansible_distribution }} {{ ansible_distribution_version }}
          KERNEL={{ ansible_kernel }}
        dest: /etc/ami-metadata
        mode: '0644'
    
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          ============================================
          Golden AMI Configuration Complete!
          ============================================
          Roles Applied:
            ✓ base
            {{ '✓' if enable_security_hardening else '✗' }} security
            {{ '✓' if install_cloudwatch_agent else '✗' }} monitoring
          ============================================
