---
# =============================================================================
# Security Role - Hardening Configuration
# =============================================================================
# This role applies security hardening based on CIS benchmarks and
# AWS best practices for EC2 instances.
# =============================================================================

# -----------------------------------------------------------------------------
# SSH Hardening
# -----------------------------------------------------------------------------
- name: Configure SSH server hardening
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
    validate: '/usr/sbin/sshd -t -f %s'
  loop:
    - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
    - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
    - { regexp: '^#?PermitEmptyPasswords', line: 'PermitEmptyPasswords no' }
    - { regexp: '^#?X11Forwarding', line: 'X11Forwarding no' }
    - { regexp: '^#?MaxAuthTries', line: 'MaxAuthTries 3' }
    - { regexp: '^#?ClientAliveInterval', line: 'ClientAliveInterval 300' }
    - { regexp: '^#?ClientAliveCountMax', line: 'ClientAliveCountMax 2' }
    - { regexp: '^#?AllowAgentForwarding', line: 'AllowAgentForwarding no' }
    - { regexp: '^#?AllowTcpForwarding', line: 'AllowTcpForwarding no' }
    - { regexp: '^#?Protocol', line: 'Protocol 2' }
  notify: Validate SSH config

- name: Set SSH banner
  ansible.builtin.copy:
    content: |
      ===============================================================================
                              AUTHORIZED ACCESS ONLY
      ===============================================================================
      This system is for authorized users only. All activities may be monitored
      and recorded. Unauthorized access is prohibited and may be subject to
      criminal prosecution.
      ===============================================================================
    dest: /etc/ssh/banner
    mode: '0644'

- name: Enable SSH banner
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Banner'
    line: 'Banner /etc/ssh/banner'
    state: present
  notify: Validate SSH config

# -----------------------------------------------------------------------------
# File Permissions
# -----------------------------------------------------------------------------
- name: Set secure permissions on sensitive files
  ansible.builtin.file:
    path: "{{ item.path }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: '/etc/passwd', mode: '0644' }
    - { path: '/etc/shadow', mode: '0000' }
    - { path: '/etc/group', mode: '0644' }
    - { path: '/etc/gshadow', mode: '0000' }
    - { path: '/etc/ssh/sshd_config', mode: '0600' }
  ignore_errors: yes

- name: Ensure /tmp has correct permissions
  ansible.builtin.file:
    path: /tmp
    mode: '1777'
    state: directory

# -----------------------------------------------------------------------------
# Kernel Security Parameters
# -----------------------------------------------------------------------------
- name: Configure security-related sysctl parameters
  ansible.builtin.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-security.conf
    reload: yes
  loop:
    # Disable IP forwarding
    - { key: 'net.ipv4.ip_forward', value: '0' }
    # Disable ICMP redirects
    - { key: 'net.ipv4.conf.all.accept_redirects', value: '0' }
    - { key: 'net.ipv4.conf.default.accept_redirects', value: '0' }
    - { key: 'net.ipv6.conf.all.accept_redirects', value: '0' }
    - { key: 'net.ipv6.conf.default.accept_redirects', value: '0' }
    # Disable source routing
    - { key: 'net.ipv4.conf.all.accept_source_route', value: '0' }
    - { key: 'net.ipv4.conf.default.accept_source_route', value: '0' }
    # Enable TCP SYN cookies
    - { key: 'net.ipv4.tcp_syncookies', value: '1' }
    # Log suspicious packets
    - { key: 'net.ipv4.conf.all.log_martians', value: '1' }
    - { key: 'net.ipv4.conf.default.log_martians', value: '1' }
    # Ignore ICMP broadcasts
    - { key: 'net.ipv4.icmp_echo_ignore_broadcasts', value: '1' }
    # Ignore bogus ICMP errors
    - { key: 'net.ipv4.icmp_ignore_bogus_error_responses', value: '1' }
    # Enable reverse path filtering
    - { key: 'net.ipv4.conf.all.rp_filter', value: '1' }
    - { key: 'net.ipv4.conf.default.rp_filter', value: '1' }
    # Randomize virtual address space
    - { key: 'kernel.randomize_va_space', value: '2' }

# -----------------------------------------------------------------------------
# Disable Unnecessary Services
# -----------------------------------------------------------------------------
- name: Disable unnecessary services
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    enabled: no
  loop:
    - rpcbind
    - cups
    - avahi-daemon
  ignore_errors: yes

# -----------------------------------------------------------------------------
# Remove Unnecessary Packages
# -----------------------------------------------------------------------------
- name: Remove unnecessary packages
  ansible.builtin.yum:
    name:
      - telnet-server
      - rsh-server
      - rsh
      - ypbind
      - ypserv
      - tftp
      - tftp-server
      - talk
      - talk-server
    state: absent
  ignore_errors: yes

# -----------------------------------------------------------------------------
# Audit Configuration
# -----------------------------------------------------------------------------
- name: Ensure auditd is installed
  ansible.builtin.yum:
    name: audit
    state: present

- name: Configure audit rules
  ansible.builtin.copy:
    content: |
      # Golden AMI Audit Rules
      
      # Monitor changes to user/group files
      -w /etc/passwd -p wa -k identity
      -w /etc/group -p wa -k identity
      -w /etc/shadow -p wa -k identity
      -w /etc/gshadow -p wa -k identity
      
      # Monitor changes to sudoers
      -w /etc/sudoers -p wa -k sudoers
      -w /etc/sudoers.d/ -p wa -k sudoers
      
      # Monitor SSH configuration
      -w /etc/ssh/sshd_config -p wa -k sshd
      
      # Monitor system calls for privilege escalation
      -a always,exit -F arch=b64 -S setuid -S setgid -k privilege_escalation
      
      # Monitor failed access attempts
      -a always,exit -F arch=b64 -S open -F exit=-EACCES -k access
      -a always,exit -F arch=b64 -S open -F exit=-EPERM -k access
    dest: /etc/audit/rules.d/golden-ami.rules
    mode: '0640'
  notify: Restart auditd

- name: Enable and start auditd
  ansible.builtin.systemd:
    name: auditd
    state: started
    enabled: yes

# -----------------------------------------------------------------------------
# Password Policy
# -----------------------------------------------------------------------------
- name: Configure password aging policy
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^PASS_MAX_DAYS', line: 'PASS_MAX_DAYS 90' }
    - { regexp: '^PASS_MIN_DAYS', line: 'PASS_MIN_DAYS 7' }
    - { regexp: '^PASS_MIN_LEN', line: 'PASS_MIN_LEN 14' }
    - { regexp: '^PASS_WARN_AGE', line: 'PASS_WARN_AGE 7' }

# -----------------------------------------------------------------------------
# Login Banner
# -----------------------------------------------------------------------------
- name: Configure login banner
  ansible.builtin.copy:
    content: |
      ===============================================================================
                              AUTHORIZED ACCESS ONLY
      ===============================================================================
      Unauthorized access to this system is prohibited and may be subject to
      criminal prosecution. All activities on this system may be monitored and
      recorded.
      ===============================================================================
    dest: "{{ item }}"
    mode: '0644'
  loop:
    - /etc/issue
    - /etc/issue.net
